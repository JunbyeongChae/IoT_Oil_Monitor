## 📄 스마트 오일 탱크 잔량 모니터링 시스템 기획/설계서

### I. 프로젝트 개요 및 요구사항 정의 (MRD/PRD)

| 항목 | 내용 |
| :--- | :--- |
| **프로젝트명** | 스마트 오일 탱크 잔량 모니터링 시스템 (IoT Oil Tank Level Monitor) |
| **목표** | 기존 단독주택 기름보일러의 **수동 잔량 확인 불편함** 해소 및 **실시간 원격 모니터링** 시스템 구축. |
| **해결할 문제** | ① 깊은 탱크(1200mm)에 적합한 기성품 센서의 부재. ② 외부에 설치해야 하는 시스템의 **내구성 및 방수** 문제 해결. |
| **핵심 기술** | ESP32 기반 Wi-Fi 통신, 비접촉식 초음파 거리 측정, Blynk 클라우드 연동. |
| **KPI (핵심 성과 지표)** | 잔량 측정 **정확도 95% 이상** / 실외 시스템 **가동률 99.9% 이상**. |

---

### II. 핵심 요구사항 (Core Requirements)

| 분류 | ID | 요구사항 내용 | 중요도 |
| :--- | :--- | :--- | :--- |
| **기능** | **R-01** | 초음파 센서를 이용한 탱크 내 **빈 공간 거리(cm)** 측정 및 전송. | A |
| | **R-02** | 측정된 거리를 기반으로 **실제 잔량(%)**을 계산하여 전송. | A |
| | **R-03** | 잔량이 **15% 이하**로 떨어질 때 **모바일 푸시 알림** 기능 제공. | A |
| | **R-04** | 잔량 측정 및 데이터 전송 주기를 **5분** 간격으로 유지. | B |
| **비기능** | **NF-01** | 전체 시스템은 **IP66 방수 등급** 이상의 실외 환경 내구성을 갖출 것. | A |
| | **NF-02** | 긴 케이블 사용 환경에서 **5V 3A** 어댑터와 **C-Type** 기반의 안정적인 전원 공급을 확보할 것. | A |
| | **NF-03** | 코드 및 하드웨어 연결은 **38핀 스크류 터미널 쉴드**를 활용하여 견고성을 확보할 것. | B |

---

### III. 시스템 상세 설계 (HLD/LLD)

#### 1. 하드웨어 구성 및 핀 맵 (Pin Map)

* **MCU:** ESP32-WROOM-32 (C-Type, 38핀)
* **센서:** AJ-SR04M 방수 초음파 센서 (측정 깊이: 120cm)

| ESP32 핀 | AJ-SR04M 핀 | 연결 역할 |
| :--- | :--- | :--- |
| **5V (or VIN)** | **VCC** | 전원 공급 (5V) |
| **GND** | **GND** | 접지 |
| **GPIO 25** | **Trig** | 초음파 신호 발생 (출력) |
| **GPIO 26** | **Echo** | 초음파 반사 신호 수신 (입력) |
| **USB-C** | **5V 3A Adapter** | 전원 입력 |

#### 2. 소프트웨어 및 통신 설계

| 항목 | 내용 |
| :--- | :--- |
| **개발 언어** | C++ (Arduino Sketch) |
| **통신 프로토콜** | Wi-Fi (802.11 b/g/n) 및 Blynk VIRTUAL WRITE (TCP/IP) |
| **IoT 플랫폼** | Blynk IoT |
| **Blynk 가상 핀** | **V0:** 빈 공간 거리 (cm), **V1:** 잔량 퍼센트 (%) |
| **주요 라이브러리** | `BlynkSimpleEsp32.h`, `NewPing.h` |

#### 3. 핵심 알고리즘 및 데이터 처리

| 항목 | 공식/로직 |
| :--- | :--- |
| **탱크 전체 높이** | **$H = 120 cm$** |
| **잔량 (cm)** | **$L_{oil} = H - L_{air}$** ( $L_{air}$ : 센서 측정 빈 공간 거리) |
| **잔량 퍼센트 (%)** | **$P = ( L_{oil} / H ) \times 100$** |
| **데이터 보정** | 측정값 $L_{air}$ 가 0cm 이거나, $H$ (120cm)를 초과할 경우, 이전 데이터 유지 또는 **`NewPing::ping_cm()`**의 오류 처리 로직 활용. |

---

### IV. 시스템 패키징 설계 (NF-01, NF-02, NF-03 대응)

| 구성 요소 | 역할 | 규격 명시 |
| :--- | :--- | :--- |
| **보호 케이스** | 외부 환경(습기, 비, 먼지) 차단 | **ABS 플라스틱 방수 정션 박스 (IP66)** |
| **내부 안정화** | ESP32와 센서 선의 물리적 연결 안정화 | **38핀 스크류 터미널 쉴드** |
| **케이블 마감** | 전원/센서 선이 통과하는 구멍의 방수 밀봉 | **케이블 글랜드 PG7 (전원), PG9 (센서)** |
| **센서 고정/밀봉** | 탱크 뚜껑과 센서 사이의 틈새 방수 처리 | **방수 실리콘 실란트** |