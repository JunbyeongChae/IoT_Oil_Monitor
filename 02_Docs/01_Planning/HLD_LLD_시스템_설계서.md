# 🏗️ 시스템 상세 설계서 (HLD/LLD)

## 📌 1. 시스템 아키텍처 (High-Level Design, HLD)

### 1.1. 시스템 구성 다이어그램

본 시스템은 센싱, 처리, 통신, 사용자 인터페이스의 4단계로 구성된 클라우드 기반 IoT 아키텍처를 채택한다.



| 구분 | 구성 요소 | 역할 |
| :--- | :--- | :--- |
| **센싱** | AJ-SR04M 방수 센서 | 기름 표면까지의 거리(L_air) 측정 |
| **처리** | ESP32-WROOM-32 | 측정값 수신, 잔량 계산 알고리즘 수행 |
| **통신** | WiFi Module (내장) | Blynk 클라우드 서버로 데이터 전송 |
| **클라우드** | Blynk IoT | 데이터 저장, 실시간 모니터링, 푸시 알림 로직 수행 |
| **UI/UX** | Mobile App | 사용자 인터페이스 제공 및 알림 수신 |

### 1.2. 데이터 흐름 (Data Flow)

1.  **센싱:** AJ-SR04M이 초음파를 발사하여 빈 공간 거리 ($L_{air}$) 측정.
2.  **처리:** ESP32가 $L_{air}$를 수신 후 잔량($L_{oil}$) 및 퍼센트($P$)로 변환.
3.  **전송:** ESP32가 $L_{air}$ (V0), $P$ (V1) 데이터를 WiFi를 통해 Blynk 서버로 전송.
4.  **수신:** Blynk 서버가 데이터를 모바일 앱으로 전달하고, 잔량 부족 시 알림 발생 (R-03).

---

## 📌 2. 하드웨어 상세 설계 (Low-Level Design, LLD)

### 2.1. 핀 맵 (Pin Map) 상세

| ESP32 핀 | AJ-SR04M 핀 | 연결 역할 | 기능/주의사항 |
| :--- | :--- | :--- | :--- |
| **GPIO 25** | **Trig** | 초음파 신호 출력 | 센서에 트리거 펄스 제공 |
| **GPIO 26** | **Echo** | 반사 신호 입력 | 수신된 신호 시간을 측정 (NewPing 라이브러리 사용) |
| **5V (or VIN)** | **VCC** | 전원 공급 | 센서 구동 전원 |
| **GND** | **GND** | 접지 | 공통 접지 |
| **USB-C** | N/A | 전원 입력 | 5V 3A C-Type 어댑터 사용 (NF-02 충족) |

### 2.2. 전원 및 패키징 설계 (NF-01, NF-02, NF-03 대응)

| 구성 요소 | 역할 및 상세 규격 | 설계 근거 |
| :--- | :--- | :--- |
| **패키징** | ABS 방수 정션 박스 | **IP66 등급** 확보를 통한 실외 환경 완벽 대응 (NF-01). |
| **전원 공급** | 5V 3A C-Type 어댑터 | 3m 이상 긴 케이블 환경에서 **전압 강하를 방지**하여 안정적인 ESP32 구동 보장 (NF-02). |
| **내부 결선** | 38핀 스크류 터미널 쉴드 | 납땜 없이도 **진동 및 습기에 강한** 견고한 연결 (NF-03). |
| **케이블 마감** | PG7, PG9 케이블 글랜드 | 전원선(PG7) 및 센서선(PG9)의 인장력 확보 및 방수 밀봉. |

---

## 📌 3. 소프트웨어 및 알고리즘 상세 설계 (LLD)

### 3.1. 잔량 측정 알고리즘

| 항목 | 기호 | 값 및 로직 | 설명 |
| :--- | :--- | :--- | :--- |
| **탱크 높이** | $H$ | 120 cm | 사용자가 정의한 탱크의 총 깊이 |
| **측정 거리** | $L_{air}$ | `sonar.ping_cm()` | 센서부터 기름 표면까지의 빈 공간 거리 (cm) |
| **잔량 (cm)** | $L_{oil}$ | $L_{oil} = H - L_{air}$ | 탱크 높이에서 측정 거리를 뺀 실제 기름 높이 |
| **잔량 (%)** | $P$ | $P = \text{constrain}(\text{map}(L_{oil}, 0, H, 0, 100), 0, 100)$ | 0~100%로 변환 및 범위 강제 고정 |

### 3.2. 통신 및 로직 상세

* **통신 주기 (R-04):** `timer.setInterval(300000L, sendTankData);` (5분 = 300,000 밀리초)
* **잔량 부족 알림 (R-03):** Blynk 서버의 Automation 기능을 사용하여 $P < 15$ 일 때 모바일 알림 트리거.
* **NewPing 초기화:** `NewPing sonar(TRIGGER_PIN, ECHO_PIN, MAX_DISTANCE);` (MAX_DISTANCE = 400cm 설정)

### 3.3. 오류 처리 로직 (Data Validation)

1.  **측정 오류:** 센서가 유효하지 않은 값(0cm 또는 400cm 초과)을 반환할 경우, 해당 데이터를 Blynk에 전송하지 않고, **Serial Monitor에만 오류 로그를 출력**하며 다음 측정 주기를 기다린다.
2.  **Wi-Fi 재접속:** Wi-Fi 연결이 끊어질 경우, `Blynk.begin()` 함수를 사용하여 **자동으로 연결을 시도**하도록 코드를 설계한다.